
-----------------------------------------------------
local a=CasinoKit.L;local b=CasinoKit.class("HoldEmCl","CardGameCl")function b:getGameFriendlyName()return"Hold 'em"end;function b:getGameFriendlySubtext()return a("#ante %d - #smallbet %d",self:getAnte(),self:getSmallBet())end;function b:getAnte()local c=self:getTableEntity()return IsValid(c)and c:GetAnte()or-1 end;function b:getSmallBet()local c=self:getTableEntity()return IsValid(c)and c:GetSmallBet()or-1 end;function b:getTimeoutDelay()local c=self:getTableEntity()return IsValid(c)and c:GetTimeoutDelay()or-1 end;function b:handleGameMessage(d,e)if d=="ccard"then self.communityCards=self.communityCards or{}local f=#self.communityCards;local g=self:createCardObject(e:getCard(),Vector(5,-3.5+(f-1)*5,0))table.insert(self.communityCards,g)elseif d=="nturn"then self.turn=e:get()local h=e:get()self.turnStartTime=CurTime()self.turnEndTime=self.turnStartTime+h;self.askingForAmount=e:getInt()if self:getTableEntity():GetMySeatIndex()==self.turn then surface.PlaySound("HL1/fvox/bell.wav")end elseif d=="chpot"then self.pot=e:getInt()self.sidepots=e:getArray(function(i,j)return e:getInt()end)local k=table.Random{"chipsHandle1.ogg","chipsHandle3.ogg","chipsHandle4.ogg","chipsHandle5.ogg","chipsHandle6.ogg"}self:playTableSound("file:sound/casinokit/"..k)elseif d=="fipot"then local function l(m)local n={name=m,handName=e:getString(),amount=e:getInt(),winnerSeats=e:getArray(function()return e:get()end)}local o={}for i,p in pairs(n.winnerSeats)do local q=self:getSeatPly(self:getTableEntity(),p)table.insert(o,IsValid(q)and q:Nick()or"-")end;n.winnersString=table.concat(o,",")return n end;self.finalPotData=e:getArray(function(i,r)return l(e:getString())end)else b.super.handleGameMessage(self,d,e)end end;function b:onStateChanged(s)b.super.onStateChanged(self,s)if s=="gameover"then self.communityCards=nil;self.sidepots={}self.pot=0;self.finalPotData={}end end;function b:getCardHorizOffset(t)return(t-1.5)*0.20 end;function b:getCardVertOffset(t)return 22 end;function b:drawTable(u,v)b.super.drawTable(self,u,v)for f,w in pairs(self.communityCards or{})do self:drawCard(u,v,w)end;local x=u:LocalToWorld(v+Vector(13,0,0))CasinoKit.drawChipStack(self.pot or 0,x,u:GetAngles(),true)for r,y in pairs(self.sidepots or{})do local x=u:LocalToWorld(v+Vector(13,r*7,0))CasinoKit.drawChipStack(y or 0,x,u:GetAngles(),true)end end;function b:sendAction(u,z)local A=CasinoKit.classes.OutBuffer()A:putString(z)self:sendInput(A)end;function b:stateMessage()local B=self.state;if not B then return"-"end;if B=="idle"then return a"#waiting"end;local C=string.format("#holdem_%s",B)return a(C)end;function b:getActivityPosition(u,v)local D=self.super.getActivityPosition(self,u,v)if D then return D end;local E=self:getTurnGmodPly(u)if IsValid(E)then return E:EyePos()end end;function b:getSeatPly(u,p)for i,F in pairs(u:GetCachedSeatindexPlyTuples())do if F[1]==p then return F[2]end end end;function b:getTurnGmodPly(u)local G=self.turn;return self:getSeatPly(u,G)end;function b:helpMessage(u)if self.state=="preFlopBets"or self.state=="flopBets"or self.state=="turnBets"or self.state=="riverBets"then local G=self.turn;if u:GetSeatIndex()==G then return a("#callingfor %d",self.askingForAmount or 0)else local H=self:getTurnGmodPly(u)return a("#turn: %s",IsValid(H)and H:Nick()or"")end end end;function b:onGameplayMessageReceived(I)b.super.onGameplayMessageReceived(self,I)if self.holdemGameplayMessage then self.holdemGameplayMessage.replaced=CurTime()self.holdemOldGameplayMessages=self.holdemOldGameplayMessages or{}table.insert(self.holdemOldGameplayMessages,self.holdemGameplayMessage)end;self.holdemGameplayMessage={msg=I}end;function b:drawUI(u,J)b.super.drawUI(self,u,J)local K=self.holdemGameplayMessages or{}local L=self.holdemGameplayMessage;if L then J:Text(L.msg or"","!Roboto@11",0,-40)end;if self.holdemOldGameplayMessages then for i,M in pairs(self.holdemOldGameplayMessages)do local N=(CurTime()-M.replaced)/2;if N>1 then table.RemoveByValue(self.holdemOldGameplayMessages,M)else local O=N*N;J:Text(M.msg or"","!Roboto@11",0,-50+O*-50,Color(255,255,255,(1-O)*255))end end end;local P=self:helpMessage(u)J:Rect(-85,-25,170,P and 50 or 25,nil,Color(255,255,255))J:Text(self:stateMessage(),"!Roboto@18",0,-22)if P then J:Line(-80,-2,80,-2)J:Text(P,"!Roboto@15",0,5)end;local Q=self:getTurnGmodPly(u)if(self.state=="preFlopBets"or self.state=="flopBets"or self.state=="turnBets"or self.state=="riverBets")and Q==LocalPlayer()then if self.turnStartTime and self.turnEndTime then local R=CurTime()-self.turnStartTime;local S=R/(self.turnEndTime-self.turnStartTime)J:Rect(-85,32,170,5,nil,Color(255,255,255))J:Rect(-85,32,170*(1-S),5,Color(255,255,255),nil)end;local T=self.askingForAmount or 0;local U=LocalPlayer():CKit_GetChips()>=T;if U and J:Button(T==0 and a"#holdem_check"or a"#holdem_call","!Roboto@17",-85,45,80,30)then self:sendAction(u,"call")end;if U and J:Button(T==0 and a"#holdem_bet"or a"#holdem_raise","!Roboto@17",5,45,80,30)then self:sendAction(u,"raise")end;if not U and J:Button(a"#holdem_allin","!Roboto@17",-85,80,80,30)then self:sendAction(u,"allin")end;if J:Button(a"#holdem_fold","!Roboto@17",5,80,80,30)then self:sendAction(u,"fold")end end;if self.finalPotData then for r,V in pairs(self.finalPotData)do local W=string.format("%s: %s",V.name,a("#holdem_potwin",V.winnersString,V.amount,V.handName))J:Text(W,"!Roboto@18",90,-37+r*15,nil,TEXT_ALIGN_LEFT)end end end;function b:addGameSettings(X)X:integer("Ante","ante",self:getAnte(),5,10000)X:integer("Small bet","smallbet",self:getSmallBet(),5,10000)X:integer("Timeout delay (seconds)","timeoutdelay",self:getTimeoutDelay(),5,180)b.super.addGameSettings(self,X)end;b.htmlHelp=[[
<h2>Hold 'em rules</h2>
<p>
	Click <a href="javascript:openRules()">here</a> to open hold 'em rules.
</p>
<script>
	function openRules() {
		gmod.OpenUrl('https://en.wikipedia.org/wiki/Texas_hold_%27em#Play_of_the_hand')
	}
</script>
]]